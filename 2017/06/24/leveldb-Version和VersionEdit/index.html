<!doctype html>




<html class="theme-next pisces" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="leveldb," />








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.1" />






<meta name="description" content="leveldb中的版本控制在leveldb之中，随着插入的数据不断增加，数据从memtable不断向更高level的sstable迁移，leveldb内部管理的各个level的文件内容不断发生变化，这种数据的迁移在leveldb内部通过版本控制进行管理。 版本管理通过3个数据结构进行管理，Version表示某一个特定的版本，包括这个版本各个level的文件以及其他数据库相关文件等，VersionE">
<meta name="keywords" content="leveldb">
<meta property="og:type" content="article">
<meta property="og:title" content="leveldb Version和VersionEdit">
<meta property="og:url" content="http://zhoudayang.github.io/2017/06/24/leveldb-Version和VersionEdit/index.html">
<meta property="og:site_name" content="zhouyang&#39;s blog">
<meta property="og:description" content="leveldb中的版本控制在leveldb之中，随着插入的数据不断增加，数据从memtable不断向更高level的sstable迁移，leveldb内部管理的各个level的文件内容不断发生变化，这种数据的迁移在leveldb内部通过版本控制进行管理。 版本管理通过3个数据结构进行管理，Version表示某一个特定的版本，包括这个版本各个level的文件以及其他数据库相关文件等，VersionE">
<meta property="og:image" content="https://ws3.sinaimg.cn/large/006tNc79gy1fgwb3xlvnzj30fj03pmxp.jpg">
<meta property="og:updated_time" content="2017-06-24T08:06:55.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="leveldb Version和VersionEdit">
<meta name="twitter:description" content="leveldb中的版本控制在leveldb之中，随着插入的数据不断增加，数据从memtable不断向更高level的sstable迁移，leveldb内部管理的各个level的文件内容不断发生变化，这种数据的迁移在leveldb内部通过版本控制进行管理。 版本管理通过3个数据结构进行管理，Version表示某一个特定的版本，包括这个版本各个level的文件以及其他数据库相关文件等，VersionE">
<meta name="twitter:image" content="https://ws3.sinaimg.cn/large/006tNc79gy1fgwb3xlvnzj30fj03pmxp.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'O9P846Q7QC',
      apiKey: '7ccbed52df595f2d66c7be0f9035d420',
      indexName: 'imzy',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://zhoudayang.github.io/2017/06/24/leveldb-Version和VersionEdit/"/>





  <title>leveldb Version和VersionEdit | zhouyang's blog</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  















  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">zhouyang's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://zhoudayang.github.io/2017/06/24/leveldb-Version和VersionEdit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhou Yang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://or5t01ef4.bkt.clouddn.com/12538446.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhouyang's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">leveldb Version和VersionEdit</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-24T16:06:55+08:00">
                2017-06-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/leveldb/" itemprop="url" rel="index">
                    <span itemprop="name">leveldb</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="leveldb中的版本控制"><a href="#leveldb中的版本控制" class="headerlink" title="leveldb中的版本控制"></a>leveldb中的版本控制</h1><p>在leveldb之中，随着插入的数据不断增加，数据从memtable不断向更高level的sstable迁移，leveldb内部管理的各个level的文件内容不断发生变化，这种数据的迁移在leveldb内部通过版本控制进行管理。</p>
<p>版本管理通过3个数据结构进行管理，Version表示某一个特定的版本，包括这个版本各个level的文件以及其他数据库相关文件等，VersionEdit表示从上一个版本变更到下一个版本的变化量，将VersionEdit应用到上一个Version之上就得到了更新之后的Version。而VersionSet则用于leveldb的版本管理，其中维护了当前使用的各种版本，特别是最新版本。</p>
<h1 id="Version"><a href="#Version" class="headerlink" title="Version"></a>Version</h1><p>Version类定义如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Version</span> </span>&#123;</div><div class="line"> <span class="keyword">public</span>:</div><div class="line">  <span class="comment">// Append to *iters a sequence of iterators that will</span></div><div class="line">  <span class="comment">// yield the contents of this Version when merged together.</span></div><div class="line">  <span class="comment">// REQUIRES: This version has been saved (see VersionSet::SaveTo)</span></div><div class="line">  <span class="comment">/// 向iters加入当前Version的内容对应的iterator，在合并之前内容不会修改</span></div><div class="line">  <span class="comment">/// 对level0和其他level做了区分处理</span></div><div class="line">  <span class="comment">/// 当前level所有文件的iterator加入iters中</span></div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">AddIterators</span><span class="params">(<span class="keyword">const</span> ReadOptions&amp;, std::vector&lt;Iterator*&gt;* iters)</span></span>;</div><div class="line"></div><div class="line">  struct GetStats &#123;</div><div class="line">    FileMetaData* seek_file; <span class="comment">// 查找的文件</span></div><div class="line">    <span class="keyword">int</span> seek_file_level; <span class="comment">// 查找的文件的level</span></div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="comment">// Lookup the value for key.  If found, store it in *val and</span></div><div class="line">  <span class="comment">// return OK.  Else return a non-OK status.  Fills *stats.</span></div><div class="line">  <span class="comment">// REQUIRES: lock is not held</span></div><div class="line">  <span class="comment">/// 查找key的value，若找到了存储在*val之中，并返回OK，否则返回non-OK status。记录stats。</span></div><div class="line">  <span class="comment">/// 要求：没有持有锁</span></div><div class="line">  <span class="function">Status <span class="title">Get</span><span class="params">(<span class="keyword">const</span> ReadOptions&amp;, <span class="keyword">const</span> LookupKey&amp; key, std::string* val,</span></span></div><div class="line">             GetStats* stats);</div><div class="line"></div><div class="line">  <span class="comment">// Adds "stats" into the current state.  Returns true if a new</span></div><div class="line">  <span class="comment">// compaction may need to be triggered, false otherwise.</span></div><div class="line">  <span class="comment">// REQUIRES: lock is held</span></div><div class="line">  <span class="comment">/// 将stats添加到当前的state之中。如果需要compaction返回true，否则返回false。</span></div><div class="line">  <span class="comment">/// 要求：已经持有锁</span></div><div class="line">  <span class="function">bool <span class="title">UpdateStats</span><span class="params">(<span class="keyword">const</span> GetStats&amp; stats)</span></span>;</div><div class="line"></div><div class="line">  <span class="comment">// Record a sample of bytes read at the specified internal key.</span></div><div class="line">  <span class="comment">// Samples are taken approximately once every config::kReadBytesPeriod</span></div><div class="line">  <span class="comment">// bytes.  Returns true if a new compaction may need to be triggered.</span></div><div class="line">  <span class="comment">// REQUIRES: lock is held</span></div><div class="line">  <span class="comment">/// 读 指定key的a sample of bytes 。具体读多少数据取决于config::kReadBytesPeriod</span></div><div class="line">  <span class="comment">/// 如果触发了新的compaction就返回true。</span></div><div class="line">  <span class="comment">/// 要求：持有锁</span></div><div class="line">  <span class="function">bool <span class="title">RecordReadSample</span><span class="params">(Slice key)</span></span>;</div><div class="line"></div><div class="line">  <span class="comment">// Reference count management (so Versions do not disappear out from</span></div><div class="line">  <span class="comment">// under live iterators)</span></div><div class="line">  <span class="comment">/// 引用计数管理, 所以对应iterator存活时，Versions不会消失</span></div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">Ref</span><span class="params">()</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">Unref</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">  <span class="comment">/// 在*input保存所有level对应的和[begin,end]overlap的文件</span></div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">GetOverlappingInputs</span><span class="params">(</span></span></div><div class="line">      <span class="keyword">int</span> level,</div><div class="line">      <span class="keyword">const</span> InternalKey* begin,         // NULL means before all keys</div><div class="line">      <span class="keyword">const</span> InternalKey* end,           // NULL means after all keys</div><div class="line">      std::vector&lt;FileMetaData*&gt;* inputs);</div><div class="line"></div><div class="line">  <span class="comment">// Returns true iff some file in the specified level overlaps</span></div><div class="line">  <span class="comment">// some part of [*smallest_user_key,*largest_user_key].</span></div><div class="line">  <span class="comment">// smallest_user_key==NULL represents a key smaller than all keys in the DB.</span></div><div class="line">  <span class="comment">// largest_user_key==NULL represents a key largest than all keys in the DB.</span></div><div class="line">  <span class="comment">/// 若指定level中的文件和[*smallest_user_key,*largest_user_key]区间重叠就返回true</span></div><div class="line">  <span class="function">bool <span class="title">OverlapInLevel</span><span class="params">(<span class="keyword">int</span> level,</span></span></div><div class="line">                      <span class="keyword">const</span> Slice* smallest_user_key,</div><div class="line">                      <span class="keyword">const</span> Slice* largest_user_key);</div><div class="line"></div><div class="line">  <span class="comment">// Return the level at which we should place a new memtable compaction</span></div><div class="line">  <span class="comment">// result that covers the range [smallest_user_key,largest_user_key].</span></div><div class="line">  <span class="comment">/// 新的dump的memtable的结果涵盖的key的范围是[smallest_user_key,largest_user_key]</span></div><div class="line">  <span class="comment">/// 返回应该被放置在哪一个level之上</span></div><div class="line">  <span class="function"><span class="keyword">int</span> <span class="title">PickLevelForMemTableOutput</span><span class="params">(<span class="keyword">const</span> Slice&amp; smallest_user_key,</span></span></div><div class="line">                                 <span class="keyword">const</span> Slice&amp; largest_user_key);</div><div class="line"></div><div class="line">  <span class="comment">/// 返回对应level的文件数目</span></div><div class="line">  <span class="function"><span class="keyword">int</span> <span class="title">NumFiles</span><span class="params">(<span class="keyword">int</span> level)</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> files_[level].size(); &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Return a human readable string that describes this version's contents.</span></div><div class="line">  <span class="comment">/// debug 字符串</span></div><div class="line">  std::<span class="function">string <span class="title">DebugString</span><span class="params">()</span> <span class="keyword">const</span></span>;</div><div class="line"></div><div class="line"> <span class="keyword">private</span>:</div><div class="line">  friend <span class="class"><span class="keyword">class</span> <span class="title">Compaction</span></span>;</div><div class="line">  friend <span class="class"><span class="keyword">class</span> <span class="title">VersionSet</span></span>;</div><div class="line"></div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">LevelFileNumIterator</span></span>;</div><div class="line">  Iterator* NewConcatenatingIterator(<span class="keyword">const</span> ReadOptions&amp;, <span class="keyword">int</span> level) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">  <span class="comment">// Call func(arg, level, f) for every file that overlaps user_key in</span></div><div class="line">  <span class="comment">// order from newest to oldest.  If an invocation of func returns</span></div><div class="line">  <span class="comment">// false, makes no more calls.</span></div><div class="line">  <span class="comment">//</span></div><div class="line">  <span class="comment">// REQUIRES: user portion of internal_key == user_key.</span></div><div class="line">  <span class="comment">/// 按照由新到旧的顺序，和user_key重合的file，都执行函数func(arg, level, f), 若执行func的结果</span></div><div class="line">  <span class="comment">/// 为false，就break</span></div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">ForEachOverlapping</span><span class="params">(Slice user_key, Slice internal_key,</span></span></div><div class="line">                          <span class="keyword">void</span>* arg,</div><div class="line">                          bool (*func)<span class="params">(<span class="keyword">void</span>*, <span class="keyword">int</span>, FileMetaData*)</span>);</div><div class="line"></div><div class="line">  <span class="comment">/// 当前Version属于哪一个VersionSet</span></div><div class="line">  VersionSet* vset_;            <span class="comment">// VersionSet to which this Version belongs</span></div><div class="line">  <span class="comment">/// 链表中的下一个version</span></div><div class="line">  Version* next_;               <span class="comment">// Next version in linked list</span></div><div class="line">  <span class="comment">/// 链表中的上一个version</span></div><div class="line">  Version* prev_;               <span class="comment">// Previous version in linked list</span></div><div class="line">  <span class="comment">/// 引用计数</span></div><div class="line">  <span class="keyword">int</span> refs_;                    <span class="comment">// Number of live refs to this version</span></div><div class="line"></div><div class="line">  <span class="comment">// List of files per level</span></div><div class="line">  <span class="comment">/// 每个level对应的链表</span></div><div class="line">  std::vector&lt;FileMetaData*&gt; files_[config::kNumLevels];</div><div class="line"></div><div class="line">  <span class="comment">/*</span></div><div class="line">   sstable的seek次数达到一定的阈值的时候，可以认为它处在不最优的情况，而我们认为compact后</div><div class="line">   会倾向于均衡的状态，所以在一个sstable的seek次数达到一定的阈值后，主动对其进行compact是合理的。</div><div class="line">   */</div><div class="line">  <span class="comment">/*</span></div><div class="line"> 这个具体 seek 次数阈值(allowed_seeks)的确定，依赖于 sas 盘的 IO 性能:</div><div class="line">  a. 一次磁盘寻道seek耗费10ms。</div><div class="line">  b. 读或者写 1M 数据耗费 10ms (按 100M/s IO 吞吐能力)。</div><div class="line">  c. compact 1M 的数据需要 25M 的 IO:从 level-n 中读 1M 数据，从 level-n+1 中读 10~12M 数据，写入 level-n+1 中 10~12M 数据。</div><div class="line">  所以，compact 1M 的数据的时间相当于做 25 次磁盘 seek，反过来说就是，1 次 seek 相当于 compact 40k 数据。那么，可以得到 seek 阈值</div><div class="line">   allowed_seeks=sstable_size / 40k。保守设置， 当前实际的 allowed_seeks = sstable_size / 10k。</div><div class="line">   每次 compact 完成，构造新的 Version 时 (Builder::Apply()),每个 sstable 的 allowed_seeks 会计算出来保存在 FileMetaData。</div><div class="line">   在每次 get 操作的时候，如果有超过一个 sstable 文件进行了 IO，会将最后一个 IO 的 sstable 的 allowed_seeks 减一，</div><div class="line">   并检查其是否已经用光了 allowed_seeks,若是，则将该 sstable 记录成当前 Version 的 file_to_compact_,并记录其所在的 level(file_to_compact_level_)。</div><div class="line">   */</div><div class="line">  <span class="comment">// Next file to compact based on seek stats.</span></div><div class="line">  <span class="comment">/// 经seek stats评估的下一个需要compact的文件</span></div><div class="line">  FileMetaData* file_to_compact_;</div><div class="line">  <span class="comment">/// 将要compact的文件的level</span></div><div class="line">  <span class="keyword">int</span> file_to_compact_level_;</div><div class="line"></div><div class="line">  <span class="comment">// Level that should be compacted next and its compaction score.</span></div><div class="line">  <span class="comment">// Score &lt; 1 means compaction is not strictly needed.  These fields</span></div><div class="line">  <span class="comment">// are initialized by Finalize().</span></div><div class="line">  <span class="comment">/// compaction 评分，Score &lt; 1 意味着compaction在严格意义上不需要</span></div><div class="line">  <span class="keyword">double</span> compaction_score_;</div><div class="line">  <span class="comment">/// compaction 操作所在的level</span></div><div class="line">  <span class="keyword">int</span> compaction_level_;</div><div class="line"></div><div class="line">  <span class="function">explicit <span class="title">Version</span><span class="params">(VersionSet* vset)</span></span></div><div class="line">      : <span class="title">vset_</span><span class="params">(vset)</span>, <span class="title">next_</span><span class="params">(<span class="keyword">this</span>)</span>, <span class="title">prev_</span><span class="params">(<span class="keyword">this</span>)</span>, <span class="title">refs_</span><span class="params">(<span class="number">0</span>)</span>,</div><div class="line">        <span class="title">file_to_compact_</span><span class="params">(NULL)</span>,</div><div class="line">        <span class="title">file_to_compact_level_</span><span class="params">(<span class="number">-1</span>)</span>,</div><div class="line">        <span class="title">compaction_score_</span><span class="params">(<span class="number">-1</span>)</span>,</div><div class="line">        <span class="title">compaction_level_</span><span class="params">(<span class="number">-1</span>)</span> &#123;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/// destructor of Version</span></div><div class="line">  ~Version();</div><div class="line"></div><div class="line">  <span class="comment">// No copying allowed</span></div><div class="line">  Version(<span class="keyword">const</span> Version&amp;);</div><div class="line">  <span class="keyword">void</span> operator=(<span class="keyword">const</span> Version&amp;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>每一个Version主要管理当前版本的文件，即<code>files_</code>。leveldb在进行版本管理时，将所有的Version当做链表中的一个结点连接起来，其中链表的头结点对应当前最新的Version。</p>
<h2 id="AddIterators"><a href="#AddIterators" class="headerlink" title="AddIterators"></a>AddIterators</h2><p>AddIterators方法将当前Version管理的所有文件的迭代器返回给调用者。因为level-0上的sstable文件内部可能会重叠，而其他level内部的文件不会重叠，重叠只会发生在不同level之间。因而，level-0级别的sstable每一个文件需要生成一个迭代器，其他level每个level生成一个迭代器。</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">void Version::AddIterators(const ReadOptions&amp; options,</div><div class="line">                           std::vector&lt;Iterator*&gt;* iters) &#123;</div><div class="line">  <span class="comment">/// 将所有level0对应的iterators加入iters</span></div><div class="line">  <span class="comment">// Merge all level zero files together since they may overlap</span></div><div class="line">  <span class="keyword">for</span> (size_t i = <span class="number">0</span>; i &lt; files_[<span class="number">0</span>].size(); i++) &#123;</div><div class="line">    <span class="comment">/// two level iterator，from index block handle iterator to record</span></div><div class="line">    <span class="function"><span class="title">iters</span>-&gt;</span>push_back(</div><div class="line">        <span class="function"><span class="title">vset_</span>-&gt;</span><span class="function"><span class="title">table_cache_</span>-&gt;</span>NewIterator(</div><div class="line">            <span class="function"><span class="title">options</span>, files_[0][i]-&gt;</span><span class="function"><span class="title">number</span>, files_[0][i]-&gt;</span>file_size));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// For levels &gt; 0, we can use a concatenating iterator that sequentially</span></div><div class="line">  <span class="comment">// walks through the non-overlapping files in the level, opening them</span></div><div class="line">  <span class="comment">// lazily.</span></div><div class="line">  <span class="keyword">for</span> (int level = <span class="number">1</span>; level &lt; config::kNumLevels; level++) &#123;</div><div class="line">    <span class="keyword">if</span> (!files_[level].empty()) &#123;</div><div class="line">      <span class="comment">/// two level itertor, from LevelFileNumIterator to sstable iterator</span></div><div class="line">      <span class="function"><span class="title">iters</span>-&gt;</span>push_back(NewConcatenatingIterator(options, level));</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ConcatenatingIterator实际上本质上是一个TwoLevelIterator，完成从LevelFileNumIterator到sstable Iterator之间的转换。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> Iterator* <span class="title">GetFileIterator</span><span class="params">(<span class="keyword">void</span>* arg,</span></span></div><div class="line">                                 <span class="keyword">const</span> ReadOptions&amp; options,</div><div class="line">                                 <span class="keyword">const</span> Slice&amp; file_value) &#123;</div><div class="line">  TableCache* cache = <span class="keyword">reinterpret_cast</span>&lt;TableCache*&gt;(arg);</div><div class="line">  <span class="comment">// file number and file size 占用空间大小为16bytes</span></div><div class="line">  <span class="keyword">if</span> (file_value.size() != <span class="number">16</span>) &#123;</div><div class="line">    <span class="keyword">return</span> NewErrorIterator(</div><div class="line">        Status::Corruption(<span class="string">"FileReader invoked with unexpected value"</span>));</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">/// 返回file_number和file_size指定的sstable文件的iterator</span></div><div class="line">    <span class="keyword">return</span> cache-&gt;NewIterator(options,</div><div class="line">                              DecodeFixed64(file_value.data()), <span class="comment">// file number</span></div><div class="line">                              DecodeFixed64(file_value.data() + <span class="number">8</span>)); <span class="comment">// file size</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">Iterator* Version::NewConcatenatingIterator(<span class="keyword">const</span> ReadOptions&amp; options,</div><div class="line">                                            <span class="keyword">int</span> level) <span class="keyword">const</span> &#123;</div><div class="line">  <span class="comment">/// same level file -&gt; sstable iterator</span></div><div class="line">  <span class="keyword">return</span> NewTwoLevelIterator(</div><div class="line">      <span class="keyword">new</span> LevelFileNumIterator(vset_-&gt;icmp_, &amp;files_[level]),</div><div class="line">      &amp;GetFileIterator, vset_-&gt;table_cache_, options);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Get"><a href="#Get" class="headerlink" title="Get"></a>Get</h2><p>Get函数从当前Version管理的sstable文件之中获取key对应的value。它依次遍历每个level的sstable文件进行查找，直到找到指定的key。对于level-0，它将和key区间重叠的每个sstable文件都取出来查找。而因为其他level内部文件不会发生区间重叠，因而只会取出一个和key区间重叠的文件进行查找。level-0的sstable，优先处理更新的文件。</p>
<figure class="highlight zephir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// 从当前version所管理的sstable之中进行搜索</span></div><div class="line"><span class="comment">/// 查找key的value，若找到了存储在*val之中，并返回OK，否则返回non-OK status。记录stats。</span></div><div class="line"><span class="comment">/// 要求：没有持有锁</span></div><div class="line">Status Version::Get(<span class="keyword">const</span> ReadOptions&amp; options,</div><div class="line">                    <span class="keyword">const</span> LookupKey&amp; k,</div><div class="line">                    std::string* value,</div><div class="line">                    GetStats* stats) &#123;</div><div class="line">  <span class="comment">/// get internal_key slice from k</span></div><div class="line">  Slice ikey = k.internal_key();</div><div class="line">  <span class="comment">/// get user key from k</span></div><div class="line">  Slice user_key = k.user_key();</div><div class="line">  <span class="keyword">const</span> Comparator* ucmp = vset_-&gt;icmp_.user_comparator();</div><div class="line">  Status s;</div><div class="line"></div><div class="line">  stats-&gt;seek_file = <span class="keyword">NULL</span>;</div><div class="line">  stats-&gt;seek_file_level = <span class="number">-1</span>;</div><div class="line">  FileMetaData* last_file_read = <span class="keyword">NULL</span>;</div><div class="line">  <span class="keyword">int</span> last_file_read_level = <span class="number">-1</span>;</div><div class="line"></div><div class="line">  <span class="comment">// We can search level-by-level since entries never hop across</span></div><div class="line">  <span class="comment">// levels.  Therefore we are guaranteed that if we find data</span></div><div class="line">  <span class="comment">// in an smaller level, later levels are irrelevant.</span></div><div class="line">  <span class="comment">/// 因为level更小的记录的sequence number更大，因此只需要沿着level从小到大进行搜索</span></div><div class="line">  std::vector&lt;FileMetaData*&gt; tmp;</div><div class="line">  FileMetaData* tmp2;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> level = <span class="number">0</span>; level &lt; config::kNumLevels; level++) &#123;</div><div class="line">    size_t num_files = files_[level].size();</div><div class="line">    <span class="keyword">if</span> (num_files == <span class="number">0</span>) <span class="keyword">continue</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Get the list of files to search in this level</span></div><div class="line">    FileMetaData* <span class="keyword">const</span>* files = &amp;files_[level][<span class="number">0</span>];</div><div class="line">    <span class="keyword">if</span> (level == <span class="number">0</span>) &#123;</div><div class="line">      <span class="comment">// Level-0 files may overlap each other.  Find all files that</span></div><div class="line">      <span class="comment">// overlap user_key and process them in order from newest to oldest.</span></div><div class="line">      tmp.reserve(num_files);</div><div class="line">      <span class="keyword">for</span> (uint32_t i = <span class="number">0</span>; i &lt; num_files; i++) &#123;</div><div class="line">        FileMetaData* f = files[i];</div><div class="line">        <span class="keyword">if</span> (ucmp-&gt;Compare(user_key, f-&gt;smallest.user_key()) &gt;= <span class="number">0</span> &amp;&amp;</div><div class="line">            ucmp-&gt;Compare(user_key, f-&gt;largest.user_key()) &lt;= <span class="number">0</span>) &#123;</div><div class="line">          <span class="comment">// 发生了重叠</span></div><div class="line">          tmp.push_back(f);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (tmp.<span class="keyword">empty</span>()) <span class="keyword">continue</span>;</div><div class="line">      <span class="comment">/// 优先按照sequence number更大level0文件来查找</span></div><div class="line">      <span class="comment">/// 按照sequence number进行排序,</span></div><div class="line">      std::sort(tmp.begin(), tmp.end(), NewestFirst);</div><div class="line">      <span class="comment">/// 返回sequence最大的哪一个</span></div><div class="line">      files = &amp;tmp[<span class="number">0</span>];</div><div class="line">      <span class="comment">/// file的数目</span></div><div class="line">      num_files = tmp.size();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="comment">// Binary search to find earliest index whose largest key &gt;= ikey.</span></div><div class="line">      uint32_t index = FindFile(vset_-&gt;icmp_, files_[level], ikey);</div><div class="line">      <span class="keyword">if</span> (index &gt;= num_files) &#123;</div><div class="line">        files = <span class="keyword">NULL</span>;</div><div class="line">        num_files = <span class="number">0</span>;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        tmp2 = files[index];</div><div class="line">        <span class="comment">/// user_key &lt; files[index] -&gt; smallest.user_key() 不满足条件, 没有发生重叠</span></div><div class="line">        <span class="keyword">if</span> (ucmp-&gt;Compare(user_key, tmp2-&gt;smallest.user_key()) &lt; <span class="number">0</span>) &#123;</div><div class="line">          <span class="comment">// All of "tmp2" is past any data for user_key</span></div><div class="line">          files = <span class="keyword">NULL</span>;</div><div class="line">          num_files = <span class="number">0</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          files = &amp;tmp2;</div><div class="line">          num_files = <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (uint32_t i = <span class="number">0</span>; i &lt; num_files; ++i) &#123;</div><div class="line">      <span class="comment">/// 记录上一次seek的file以及对应的seek_file_level</span></div><div class="line">      <span class="keyword">if</span> (last_file_read != <span class="keyword">NULL</span> &amp;&amp; stats-&gt;seek_file == <span class="keyword">NULL</span>) &#123;</div><div class="line">        <span class="comment">// We have had more than one seek for this read.  Charge the 1st file.</span></div><div class="line">        <span class="comment">/// 记录查找到记录所对应的文件以及其所在的level</span></div><div class="line">        stats-&gt;seek_file = last_file_read;</div><div class="line">        stats-&gt;seek_file_level = last_file_read_level;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      FileMetaData* f = files[i];</div><div class="line">      <span class="comment">/// 上次读取的file</span></div><div class="line">      last_file_read = f;</div><div class="line">      <span class="comment">/// 上次读取的level</span></div><div class="line">      last_file_read_level = level;</div><div class="line"></div><div class="line">      Saver saver;</div><div class="line">      saver.state = kNotFound;</div><div class="line">      saver.ucmp = ucmp;</div><div class="line">      saver.user_key = user_key;</div><div class="line">      saver.value = value;</div><div class="line">      <span class="comment">/// 获取对应sstable，将读取的结果使用saver进行保存</span></div><div class="line">      s = vset_-&gt;table_cache_-&gt;Get(options, f-&gt;number, f-&gt;file_size,</div><div class="line">                                   ikey, &amp;saver, SaveValue);</div><div class="line">      <span class="keyword">if</span> (!s.ok()) &#123;</div><div class="line">        <span class="keyword">return</span> s;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">/// 实际上，若第一次循环便返回，后续循环也不会进行了</span></div><div class="line">      <span class="keyword">switch</span> (saver.state) &#123;</div><div class="line">        <span class="keyword">case</span> kNotFound:</div><div class="line">          <span class="comment">///!!! 继续在其他文件之中搜索</span></div><div class="line">          <span class="keyword">break</span>;      <span class="comment">// Keep searching in other files</span></div><div class="line">        <span class="keyword">case</span> kFound:</div><div class="line">          <span class="keyword">return</span> s;</div><div class="line">        <span class="comment">/// the same as kNotFound</span></div><div class="line">        <span class="keyword">case</span> kDeleted:</div><div class="line">          s = Status::NotFound(Slice());  <span class="comment">// Use empty error message for speed</span></div><div class="line">          <span class="keyword">return</span> s;</div><div class="line">        <span class="keyword">case</span> kCorrupt:</div><div class="line">          s = Status::Corruption(<span class="string">"corrupted key for "</span>, user_key);</div><div class="line">          <span class="keyword">return</span> s;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 没有找到对应的key</span></div><div class="line">  <span class="keyword">return</span> Status::NotFound(Slice());  <span class="comment">// Use an empty error message for speed</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="PickLevelForMemTableOutput"><a href="#PickLevelForMemTableOutput" class="headerlink" title="PickLevelForMemTableOutput"></a>PickLevelForMemTableOutput</h1><p>对于新生成的sstable文件，此函数用于选取其应该放置的level。优先将新生成的sstable文件放置在level-0上，除非其和上一级的文件没有发生重叠，并且和grandparents level的sstable重叠区间的文件体积没有超出预设值。当然，输出的level值还受到<code>kMaxMemCompactLevel</code>的限制。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// 如果新生成的sstable与level-0中的文件有overlap，选level 0</span></div><div class="line"><span class="comment">/// 向上尝试不大于kMaxMemCompactLevel的level，如果与level产生overlap，即返回</span></div><div class="line"><span class="comment">/// 对于不产生overlap的level，同时考虑kMaxGrandParentOverlapBytes的阈值判断</span></div><div class="line"><span class="comment">/// 对于memtable，选取其放置的level</span></div><div class="line"><span class="keyword">int</span> Version::PickLevelForMemTableOutput(</div><div class="line">    <span class="keyword">const</span> Slice&amp; smallest_user_key,</div><div class="line">    <span class="keyword">const</span> Slice&amp; largest_user_key) &#123;</div><div class="line">  <span class="keyword">int</span> level = <span class="number">0</span>;</div><div class="line">  <span class="comment">/// 若在level0上没有重叠</span></div><div class="line">  <span class="built_in">if</span> (!OverlapInLevel(<span class="number">0</span>, &amp;smallest_user_key, &amp;largest_user_key)) &#123;</div><div class="line">    <span class="comment">// Push to next level if there is no overlap in next level,</span></div><div class="line">    <span class="comment">// and the #bytes overlapping in the level after that are limited.</span></div><div class="line">    InternalKey start(smallest_user_key, kMaxSequenceNumber, kValueTypeForSeek);</div><div class="line">    InternalKey limit(largest_user_key, <span class="number">0</span>, <span class="keyword">static_cast</span>&lt;ValueType&gt;(<span class="number">0</span>));</div><div class="line">    std::vector&lt;FileMetaData*&gt; overlaps;</div><div class="line">    <span class="comment">// memtable dump成的sstable，允许推向的最高level, 默认设置为2</span></div><div class="line">    <span class="built_in">while</span> (level &lt; <span class="built_in">config</span>::kMaxMemCompactLevel) &#123;</div><div class="line">      <span class="comment">/// 若和level + 1发生了重叠，那么break</span></div><div class="line">      <span class="built_in">if</span> (OverlapInLevel(level + <span class="number">1</span>, &amp;smallest_user_key, &amp;largest_user_key)) &#123;</div><div class="line">        <span class="built_in">break</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="built_in">if</span> (level + <span class="number">2</span> &lt; <span class="built_in">config</span>::kNumLevels) &#123;</div><div class="line">        <span class="comment">// Check that file does not overlap too many grandparent bytes.</span></div><div class="line">        GetOverlappingInputs(level + <span class="number">2</span>, &amp;start, &amp;limit, &amp;overlaps);</div><div class="line">        <span class="keyword">const</span> int64_t sum = TotalFileSize(overlaps);</div><div class="line">        <span class="comment">/// 重叠的文件总空间是否超出指定值20MB</span></div><div class="line">        <span class="comment">/// 为了限制和grandparent level overlap的数据的总量</span></div><div class="line">        <span class="built_in">if</span> (sum &gt; MaxGrandParentOverlapBytes(vset_-&gt;options_)) &#123;</div><div class="line">          <span class="built_in">break</span>;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      level++;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">/// 若在level0上发生了重叠，那么新dump的memtable文件也加入level0</span></div><div class="line">  <span class="built_in">return</span> level;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="RecordReadSample"><a href="#RecordReadSample" class="headerlink" title="RecordReadSample"></a>RecordReadSample</h1><p>在leveldb中认为更高level的sstable文件更加倾向于平衡，能够减少查询时访问的文件的数目。若为了访问某个值，从某个文件开始进行查找，并且不在这个文件之中，那么说明此文件应该被推向更高的level，来减少未来更多的seek操作的开销。在leveldb之中，每个sstable文件预设的阈值为<code>max(sstable_size / 10K)</code>，若某文件seek操作符合上述情况达到此次数，就会被标记，未来会在后台线程之中被进行compaction处理。RecordReadSample函数就是为了记录此情况而设的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// 对于输入的internalkey在重叠的文件上都执行Match函数，记录对于internal_key重叠的次数</span></div><div class="line"><span class="comment">/// 次数达到2次，就执行UpdateStats，减少f的allowed_seeks, 递减到0，就将其作为我们执行compaction的起点</span></div><div class="line"><span class="keyword">bool</span> Version::RecordReadSample(Slice internal_key) &#123;</div><div class="line">  ParsedInternalKey ikey;</div><div class="line">  <span class="comment">/// 解析InternalKey失败</span></div><div class="line">  <span class="keyword">if</span> (!ParseInternalKey(internal_key, &amp;ikey)) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">State</span> &#123;</span></div><div class="line">    GetStats stats;  <span class="comment">// Holds first matching file</span></div><div class="line">    <span class="keyword">int</span> matches;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">Match</span><span class="params">(<span class="keyword">void</span>* arg, <span class="keyword">int</span> level, FileMetaData* f)</span> </span>&#123;</div><div class="line">      State* state = <span class="keyword">reinterpret_cast</span>&lt;State*&gt;(arg);</div><div class="line">      state-&gt;matches++;</div><div class="line">      <span class="comment">/// 只记住第一次match时所对应的文件和level</span></div><div class="line">      <span class="keyword">if</span> (state-&gt;matches == <span class="number">1</span>) &#123;</div><div class="line">        <span class="comment">// Remember first match.</span></div><div class="line">        state-&gt;stats.seek_file = f;</div><div class="line">        state-&gt;stats.seek_file_level = level;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// We can stop iterating once we have a second match.</span></div><div class="line">      <span class="comment">/// 如果已经发生了两次level级别的重叠，那么直接暂停，不再尝试寻找</span></div><div class="line">      <span class="comment">/// 新的overlapping</span></div><div class="line">      <span class="keyword">return</span> state-&gt;matches &lt; <span class="number">2</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  State state;</div><div class="line">  state.matches = <span class="number">0</span>;</div><div class="line">  ForEachOverlapping(ikey.user_key, internal_key, &amp;state, &amp;State::Match);</div><div class="line"></div><div class="line">  <span class="comment">// Must have at least two matches since we want to merge across</span></div><div class="line">  <span class="comment">// files. But what if we have a single file that contains many</span></div><div class="line">  <span class="comment">// overwrites and deletions?  Should we have another mechanism for</span></div><div class="line">  <span class="comment">// finding such files?</span></div><div class="line">  <span class="comment">/// 如果和两个以上的level发生重叠，那么调用UpdateStats，减少allowed_seeks</span></div><div class="line">  <span class="comment">/// 若递减到0，就需要触发compaction</span></div><div class="line">  <span class="keyword">if</span> (state.matches &gt;= <span class="number">2</span>) &#123;</div><div class="line">    <span class="comment">// 1MB cost is about 1 seek (see comment in Builder::Apply).</span></div><div class="line">    <span class="keyword">return</span> UpdateStats(state.stats);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="VersionEdit"><a href="#VersionEdit" class="headerlink" title="VersionEdit"></a>VersionEdit</h1><p>Version之中，管理每个特定的sstable文件使用此数据结构进行描述：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FileMetaData</span> &#123;</span></div><div class="line">  <span class="keyword">int</span> refs;  <span class="comment">// reference count</span></div><div class="line">  <span class="keyword">int</span> allowed_seeks;          <span class="comment">// Seeks allowed until compaction compact之前允许的seek次数</span></div><div class="line">  <span class="keyword">uint64_t</span> number;            <span class="comment">// number of file</span></div><div class="line">  <span class="keyword">uint64_t</span> file_size;         <span class="comment">// File size in bytes</span></div><div class="line">  InternalKey smallest;       <span class="comment">// Smallest internal key served by table / sstable文件的最小key</span></div><div class="line">  InternalKey largest;        <span class="comment">// Largest internal key served by table / sstable文件的最大key</span></div><div class="line"></div><div class="line">  FileMetaData() : refs(<span class="number">0</span>), allowed_seeks(<span class="number">1</span> &lt;&lt; <span class="number">30</span>), file_size(<span class="number">0</span>) &#123; &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>VersionEdit记录了下一个Version相对于上一个Version之间的变化。它有自己的序列化和反序列化方法，序列化之后的字符串会记录在manifest文件之中，记录数据库最新的版本信息。</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fgwb3xlvnzj30fj03pmxp.jpg" alt=""></p>
<p>VersionEdit的主要成员如下所示：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">std</span>::<span class="built_in">string</span> comparator_; <span class="comment">// 比较器的名称</span></div><div class="line"><span class="keyword">uint64_t</span> log_number_; <span class="comment">// 日志文件编号</span></div><div class="line"><span class="keyword">uint64_t</span> prev_log_number_; <span class="comment">// 上一个日志文件编号</span></div><div class="line"><span class="keyword">uint64_t</span> next_file_number_; <span class="comment">// 下一个日志文件编号</span></div><div class="line">SequenceNumber last_sequence_; <span class="comment">// 上一个序列号</span></div><div class="line"><span class="keyword">bool</span> has_comparator_; <span class="comment">// 是否有比较器</span></div><div class="line"><span class="keyword">bool</span> has_log_number_; <span class="comment">// 是否有log number</span></div><div class="line"><span class="keyword">bool</span> has_prev_log_number_; <span class="comment">// 是否有上一个log number</span></div><div class="line"><span class="keyword">bool</span> has_next_file_number_; <span class="comment">// 是否有下一个file number</span></div><div class="line"><span class="keyword">bool</span> has_last_sequence_; <span class="comment">// 是否有上一个sequence</span></div><div class="line"><span class="comment">// 压缩点&lt;层次，InternalKey键&gt;</span></div><div class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt; <span class="built_in">std</span>::pair&lt;<span class="keyword">int</span>, InternalKey&gt; &gt; compact_pointers_;</div><div class="line"><span class="comment">// 删除文件集合</span></div><div class="line">DeletedFileSet deleted_files_;</div><div class="line"><span class="comment">// 新添加的文件集合</span></div><div class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt; <span class="built_in">std</span>::pair&lt;<span class="keyword">int</span>, FileMetaData&gt; &gt; new_files_;</div></pre></td></tr></table></figure>
<p>按照上图格式定义，就能很轻松地看懂序列化和反序列化的相关代码：</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">/// Encode VersionEdit into <span class="built_in">string</span> specified by dst</div><div class="line">void VersionEdit::EncodeTo(<span class="built_in">std</span>::<span class="built_in">string</span>* dst) const &#123;</div><div class="line">  /// has comparator, <span class="built_in">put</span> tag <span class="keyword">and</span> comparator name into dst</div><div class="line">  <span class="keyword">if</span> (has_comparator_) &#123;</div><div class="line">    PutVarint32(dst, kComparator);</div><div class="line">    PutLengthPrefixedSlice(dst, comparator_);</div><div class="line">  &#125;</div><div class="line">  /// has <span class="built_in">log</span> number, <span class="built_in">put</span> kLogNumber tag <span class="keyword">and</span> log_number_</div><div class="line">  <span class="keyword">if</span> (has_log_number_) &#123;</div><div class="line">    PutVarint32(dst, kLogNumber);</div><div class="line">    PutVarint64(dst, log_number_);</div><div class="line">  &#125;</div><div class="line">  /// has prev <span class="built_in">log</span> number, <span class="built_in">put</span> kPrevLogNumber tag <span class="keyword">and</span> prev_log_number_</div><div class="line">  <span class="keyword">if</span> (has_prev_log_number_) &#123;</div><div class="line">    PutVarint32(dst, kPrevLogNumber);</div><div class="line">    PutVarint64(dst, prev_log_number_);</div><div class="line">  &#125;</div><div class="line">  /// has next file number, <span class="built_in">put</span> kNextFileNumber tag <span class="keyword">and</span> next_file_number_</div><div class="line">  <span class="keyword">if</span> (has_next_file_number_) &#123;</div><div class="line">    PutVarint32(dst, kNextFileNumber);</div><div class="line">    PutVarint64(dst, next_file_number_);</div><div class="line">  &#125;</div><div class="line">  /// has last_sequence, <span class="built_in">put</span> kLastSequence tag <span class="keyword">and</span> last_sequence_</div><div class="line">  <span class="keyword">if</span> (has_last_sequence_) &#123;</div><div class="line">    PutVarint32(dst, kLastSequence);</div><div class="line">    PutVarint64(dst, last_sequence_);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  /// <span class="built_in">put</span> kCompactPointer tag <span class="keyword">and</span> pair&lt;level, InternelKey&gt; of each <span class="built_in">elem</span> of compact_pointers_</div><div class="line">  <span class="keyword">for</span> (size_t i = <span class="number">0</span>; i &lt; compact_pointers_.size(); i++) &#123;</div><div class="line">    PutVarint32(dst, kCompactPointer);</div><div class="line">    PutVarint32(dst, compact_pointers_[i].<span class="built_in">first</span>);  // level</div><div class="line">    PutLengthPrefixedSlice(dst, compact_pointers_[i].<span class="built_in">second</span>.Encode());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  /// <span class="built_in">put</span> kDeletedFile tag <span class="keyword">and</span> pair&lt;level, file number&gt; of each <span class="built_in">elem</span> of deleted_files_</div><div class="line">  <span class="keyword">for</span> (DeletedFileSet::const_iterator iter = deleted_files_.begin();</div><div class="line">       iter != deleted_files_.end();</div><div class="line">       ++iter) &#123;</div><div class="line">    PutVarint32(dst, kDeletedFile);</div><div class="line">    PutVarint32(dst, iter-&gt;<span class="built_in">first</span>);   // level</div><div class="line">    PutVarint64(dst, iter-&gt;<span class="built_in">second</span>);  // file number</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  /// <span class="built_in">put</span> kNewFile tag <span class="keyword">and</span> FileMetaData of each <span class="built_in">elem</span> of new_files_</div><div class="line">  <span class="keyword">for</span> (size_t i = <span class="number">0</span>; i &lt; new_files_.size(); i++) &#123;</div><div class="line">    const FileMetaData&amp; f = new_files_[i].<span class="built_in">second</span>;</div><div class="line">    PutVarint32(dst, kNewFile);</div><div class="line">    PutVarint32(dst, new_files_[i].<span class="built_in">first</span>);  // level</div><div class="line">    PutVarint64(dst, f.number);</div><div class="line">    PutVarint64(dst, f.file_size);</div><div class="line">    PutLengthPrefixedSlice(dst, f.smallest.Encode());</div><div class="line">    PutLengthPrefixedSlice(dst, f.largest.Encode());</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// Decode VersionEdit from string specified by src</span></div><div class="line">Status VersionEdit::DecodeFrom(<span class="keyword">const</span> Slice&amp; src) &#123;</div><div class="line">  <span class="comment">/// 首先进行清理</span></div><div class="line">  Clear();</div><div class="line">  Slice input = src;</div><div class="line">  <span class="comment">/// 用于记录出错消息</span></div><div class="line">  <span class="keyword">const</span> <span class="keyword">char</span>* msg = <span class="literal">NULL</span>;</div><div class="line">  <span class="keyword">uint32_t</span> tag;</div><div class="line"></div><div class="line">  <span class="comment">// Temporary storage for parsing</span></div><div class="line">  <span class="comment">/// temporary usage</span></div><div class="line">  <span class="keyword">int</span> level;</div><div class="line">  <span class="keyword">uint64_t</span> number;</div><div class="line">  FileMetaData f;</div><div class="line">  Slice str;</div><div class="line">  InternalKey key;</div><div class="line"></div><div class="line">  <span class="keyword">while</span> (msg == <span class="literal">NULL</span> &amp;&amp; GetVarint32(&amp;input, &amp;tag)) &#123;</div><div class="line">    <span class="comment">/// 读取tag</span></div><div class="line">    <span class="keyword">switch</span> (tag) &#123;</div><div class="line">      <span class="keyword">case</span> kComparator:</div><div class="line">        <span class="keyword">if</span> (GetLengthPrefixedSlice(&amp;input, &amp;str)) &#123;</div><div class="line">          comparator_ = str.ToString();</div><div class="line">          has_comparator_ = <span class="literal">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          msg = <span class="string">"comparator name"</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line"></div><div class="line">      <span class="keyword">case</span> kLogNumber:</div><div class="line">        <span class="keyword">if</span> (GetVarint64(&amp;input, &amp;log_number_)) &#123;</div><div class="line">          has_log_number_ = <span class="literal">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          msg = <span class="string">"log number"</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line"></div><div class="line">      <span class="keyword">case</span> kPrevLogNumber:</div><div class="line">        <span class="keyword">if</span> (GetVarint64(&amp;input, &amp;prev_log_number_)) &#123;</div><div class="line">          has_prev_log_number_ = <span class="literal">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          msg = <span class="string">"previous log number"</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line"></div><div class="line">      <span class="keyword">case</span> kNextFileNumber:</div><div class="line">        <span class="keyword">if</span> (GetVarint64(&amp;input, &amp;next_file_number_)) &#123;</div><div class="line">          has_next_file_number_ = <span class="literal">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          msg = <span class="string">"next file number"</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line"></div><div class="line">      <span class="keyword">case</span> kLastSequence:</div><div class="line">        <span class="keyword">if</span> (GetVarint64(&amp;input, &amp;last_sequence_)) &#123;</div><div class="line">          has_last_sequence_ = <span class="literal">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          msg = <span class="string">"last sequence number"</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="comment">/// get compact pointer</span></div><div class="line">      <span class="keyword">case</span> kCompactPointer:</div><div class="line">        <span class="keyword">if</span> (GetLevel(&amp;input, &amp;level) &amp;&amp;</div><div class="line">            GetInternalKey(&amp;input, &amp;key)) &#123;</div><div class="line">          compact_pointers_.push_back(<span class="built_in">std</span>::make_pair(level, key));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          msg = <span class="string">"compaction pointer"</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="comment">/// get deleted files</span></div><div class="line">      <span class="keyword">case</span> kDeletedFile:</div><div class="line">        <span class="keyword">if</span> (GetLevel(&amp;input, &amp;level) &amp;&amp;</div><div class="line">            GetVarint64(&amp;input, &amp;number)) &#123;</div><div class="line">          deleted_files_.insert(<span class="built_in">std</span>::make_pair(level, number));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          msg = <span class="string">"deleted file"</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="comment">/// get elem of new_files_</span></div><div class="line">      <span class="keyword">case</span> kNewFile:</div><div class="line">        <span class="keyword">if</span> (GetLevel(&amp;input, &amp;level) &amp;&amp;</div><div class="line">            GetVarint64(&amp;input, &amp;f.number) &amp;&amp;</div><div class="line">            GetVarint64(&amp;input, &amp;f.file_size) &amp;&amp;</div><div class="line">            GetInternalKey(&amp;input, &amp;f.smallest) &amp;&amp;</div><div class="line">            GetInternalKey(&amp;input, &amp;f.largest)) &#123;</div><div class="line">          new_files_.push_back(<span class="built_in">std</span>::make_pair(level, f));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          msg = <span class="string">"new-file entry"</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line"></div><div class="line">      <span class="keyword">default</span>:</div><div class="line">        msg = <span class="string">"unknown tag"</span>;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/// 输入没有读取完，并且记录的出错消息为NULL</span></div><div class="line">  <span class="keyword">if</span> (msg == <span class="literal">NULL</span> &amp;&amp; !input.empty()) &#123;</div><div class="line">    msg = <span class="string">"invalid tag"</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  Status result;</div><div class="line">  <span class="comment">/// 出错了</span></div><div class="line">  <span class="keyword">if</span> (msg != <span class="literal">NULL</span>) &#123;</div><div class="line">    result = Status::Corruption(<span class="string">"VersionEdit"</span>, msg);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/leveldb/" rel="tag"># leveldb</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/06/23/leveldb-table-cache解析/" rel="next" title="leveldb table_cache解析">
                <i class="fa fa-chevron-left"></i> leveldb table_cache解析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/06/24/leveldb-VersionSet解析/" rel="prev" title="leveldb VersionSet解析">
                leveldb VersionSet解析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="lv-container" data-id="city" data-uid="MTAyMC8yODk5Ny81NTY2"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://or5t01ef4.bkt.clouddn.com/12538446.jpeg"
               alt="Zhou Yang" />
          <p class="site-author-name" itemprop="name">Zhou Yang</p>
           
              <p class="site-description motion-element" itemprop="description">乐观的终生学习者</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">45</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/zhoudayang" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.zhihu.com/people/zhoudayang" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-知乎"></i>
                  
                  知乎
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/zyiam" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#leveldb中的版本控制"><span class="nav-text">leveldb中的版本控制</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Version"><span class="nav-text">Version</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#AddIterators"><span class="nav-text">AddIterators</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Get"><span class="nav-text">Get</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#PickLevelForMemTableOutput"><span class="nav-text">PickLevelForMemTableOutput</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#RecordReadSample"><span class="nav-text">RecordReadSample</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#VersionEdit"><span class="nav-text">VersionEdit</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhou Yang</span>
</div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  






  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.1"></script>



  

  

  

  

  

  

</body>
</html>
